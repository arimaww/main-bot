generator client {
  provider      = "prisma-client"
  output        = "../generated"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId          Int           @id @default(autoincrement())
  telegramId      String
  userName        String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @default(now()) @updatedAt
  email           String?
  firstName       String?
  middleName      String?
  phone           String?
  selectedCity    String?
  selectedCountry String?
  selectedPvzCode String?
  selectedRegion  String?
  surName         String?
  discountId      Int?
  basket          Basket[]
  keyboard        Keyboard[]
  order           Order[]
  PaymentInfo     PaymentInfo[]
}

enum PRODUCT_VISIBLE_STATUS {
  VISIBLE
  HIDDEN
  HIDDEN_ON_SITE
}

model Product {
  productId       Int                     @id @default(autoincrement())
  name            String
  synonym         String?
  description     String
  longDescription String?
  isArchived      Boolean                 @default(false) @map("is_archived")
  visibleStatus   PRODUCT_VISIBLE_STATUS? @default(VISIBLE) @map("visible_status")
  sostav          String?
  picture         String?
  count           Int
  cost            Decimal
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @default(now()) @updatedAt
  primeCost       Decimal?

  categoryId      Int?
  basket          Basket[]
  order           Order[]
  productDiscount ProductDiscount?
  productSet      ProductSet[]
  Category        Category?        @relation(fields: [categoryId], references: [id])
}

model Basket {
  basketId         Int             @id @default(autoincrement())
  userId           Int
  productId        Int
  productCount     Int
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @default(now()) @updatedAt
  promocodeId      Int?
  secretDiscountId Int?
  freeDelivery     Boolean         @default(false)
  product          Product         @relation(fields: [productId], references: [productId], onDelete: Cascade)
  promocode        Promocodes?     @relation(fields: [promocodeId], references: [promocodeId], onDelete: Cascade)
  SecretDiscount   SecretDiscount? @relation(fields: [secretDiscountId], references: [id])
  user             User            @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model Order {
  orderId                 Int           @id @default(autoincrement())
  orderTrackNumber        String?
  userId                  Int?
  surName                 String?
  firstName               String?
  middleName              String?
  productId               Int?
  productCount            Int
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @default(now()) @updatedAt
  status                  OrderStatus   @default(WAITPAY)
  orderUniqueNumber       String?
  phone                   String?
  selectedPvzCode         String?
  selectedTariff          Int?
  fileId                  String?
  deliveryCost            Int?
  bankId                  Int?
  totalPrice              Int?
  selectedCountry         String?
  email                   String?
  orderType               OrderType?
  messageId               String?
  country                 String?
  pvzCode                 String?
  index                   String?
  region                  String?
  city                    String?
  totalPriceWithDiscount  Decimal?
  productCostWithDiscount Decimal?
  promocodeId             Int?
  secretDiscountPercent   Int?
  address                 String?
  commentForCollector     String?
  commentByClient         String?
  freeDelivery            Boolean       @default(false)
  bank                    Bank?         @relation(fields: [bankId], references: [id], onDelete: SetNull)
  product                 Product?      @relation(fields: [productId], references: [productId], onDelete: SetNull)
  promocode               Promocodes?   @relation(fields: [promocodeId], references: [promocodeId], onDelete: SetNull)
  user                    User?         @relation(fields: [userId], references: [userId], onDelete: SetNull)
  orderBarcodeId          Int?
  orderBarcode            OrderBarcode? @relation(fields: [orderBarcodeId], references: [id], onDelete: SetNull)
  messages                Messages?     @relation(fields: [messagesId], references: [id])
  messagesId              Int?

  paymentInfo   PaymentInfo? @relation(fields: [paymentInfoId], references: [id])
  paymentInfoId Int?
}

model Messages {
  id                Int      @id @default(autoincrement())
  cdek_group_msg_id String
  bot_msg_id        String
  createdAt         DateTime @default(now())
  updateAt          DateTime @default(now())
  Order             Order[]
}

model OrderBarcode {
  id     Int     @id @default(autoincrement())
  url    String
  orders Order[]

  createdAt DateTime @default(now())
  updateAt  DateTime @default(now()) @updatedAt
}

model CdekOffice {
  officeId     Int      @id @default(autoincrement())
  code         String
  uuid         String
  countryCode  String
  regionCode   Int
  region       String
  cityCode     Int
  City         String
  address      String
  address_full String
  allowed_cod  Boolean?
  weight_min   Decimal? @db.Decimal(10, 1)
  weight_max   Decimal? @db.Decimal(10, 1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt
}

model UserCrm {
  id        Int      @id @unique @default(autoincrement())
  firstName String
  surName   String
  role      Role     @default(MODERATOR)
  email     String
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Bank {
  id          Int          @id @unique @default(autoincrement())
  bankName    String
  requisite   String
  isSwitchOn  Boolean?     @default(true)
  recipient   String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @default(now()) @updatedAt
  sbpNumber   String?
  paymentType PAYMENT_TYPE @default(BANK)
  comments    String?
  Order       Order[]
}

model Keyboard {
  keyboardId Int    @unique @default(autoincrement())
  chatId     BigInt @unique
  title      String
  messageId  BigInt
  userId     Int
  user       User   @relation(fields: [userId], references: [userId])
}

model ProductDiscount {
  discountId Int       @unique @default(autoincrement())
  percent    Int?
  amount     Int?
  validDate  DateTime?
  productId  Int       @unique
  updatedAt  DateTime  @default(now()) @updatedAt
  createdAt  DateTime  @default(now())
  product    Product   @relation(fields: [productId], references: [productId])
}

model ProductSet {
  setId     Int     @unique @default(autoincrement())
  setName   String
  productId Int
  discount  Int
  product   Product @relation(fields: [productId], references: [productId])
}

model Promocodes {
  promocodeId     Int      @unique @default(autoincrement())
  title           String
  uses            Int
  percent         Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  fromWhatAmount  Int
  basketWithPromo Basket[]
  ordersWithPromo Order[]
}

model GeneratedBaskets {
  gbasketId        Int             @unique @default(autoincrement())
  cartKey          String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  secretDiscountId Int?            @unique
  freeDelivery     Boolean         @default(false)
  items            BasketItems[]
  SecretDiscount   SecretDiscount? @relation(fields: [secretDiscountId], references: [id])
}

model BasketItems {
  id           Int              @unique @default(autoincrement())
  productId    Int
  productCount Int
  gbasketId    Int
  createdAt    DateTime         @default(now())
  basket       GeneratedBaskets @relation(fields: [gbasketId], references: [gbasketId])
}

model SecretDiscount {
  id               Int                  @unique @default(autoincrement())
  percent          Int
  Basket           Basket[]
  type             SecretDiscountStatus @default(PENDING)
  GeneratedBaskets GeneratedBaskets?
}

model Category {
  id        Int       @unique @default(autoincrement())
  name      String
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model PaymentInfo {
  id                Int     @unique @default(autoincrement())
  paymentId         String
  orderUniqueNumber String
  Order             Order[]

  amount Decimal // Копейки
  status PAYMENT_STATUS @default(NEW)

  user   User @relation(fields: [userId], references: [userId])
  userId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

enum PAYMENT_STATUS {
  NEW
  PROCESSING
  CONFIRMED
}

enum SecretDiscountStatus {
  PENDING
  USED
}

enum PAYMENT_TYPE {
  BANK
  CRYPTO
}

enum OrderType {
  CDEK
  MAIL
  MINIBUS
  PICKUP
}

enum OrderStatus {
  PENDING
  SUCCESS
  WAITPAY
}

enum Role {
  ADMIN
  MODERATOR
  OWNER
}
